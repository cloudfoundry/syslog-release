#!/bin/bash
set -ex

mkdir -p /var/vcap/store/syslog_storer
mkdir -p /var/vcap/data/syslog_storer/buffered
chown -R syslog:adm /var/vcap/data/syslog_storer/buffered
chown -R syslog:adm /var/vcap/store/syslog_storer

mkdir -p /etc/rsyslog.d
cp $(dirname $0)/../config/rsyslog.conf /etc/rsyslog.d/rsyslog.conf
if [ -d "/etc/apparmor.d/rsyslog.d/" ]; then
  cp $(dirname $0)/../config/syslog.apparmor /etc/apparmor.d/rsyslog.d/syslog.apparmor

  if command -v apparmor_parser &>/dev/null && [ -f "/etc/apparmor.d/usr.sbin.rsyslogd" ]; then
    apparmor_parser -r /etc/apparmor.d/usr.sbin.rsyslogd
  fi
fi

# In BOSH Lite environments, deployments fail when the pre-start script
# unconditionally restarts rsyslog with `systemctl`, because BOSH Lite
# does not use systemd as PID 1. This logic detects whether systemd is
# actually running as init (PID 1) before using `systemctl`; otherwise it
# falls back to the traditional `service` command to restart rsyslog.
if command -v systemctl &>/dev/null && systemctl list-unit-files | grep -q '^rsyslog\.service'; then
  echo "Restarting rsyslog via systemctl..."
  systemctl restart rsyslog || {
    echo "systemctl restart failed (exit $?), falling back to service"
    service rsyslog restart || echo "fallback restart also failed."
  }
else
  echo "Restarting rsyslog via service..."
  service rsyslog restart
fi