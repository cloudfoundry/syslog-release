---
name: syslog_forwarder

templates:
  pre-start.erb: bin/pre-start
  syslog-release.conf.erb: config/syslog-release.conf
  syslog-release-custom-rules.conf.erb: config/syslog-release-custom-rules.conf
  syslog-release-forwarding-rules.conf.erb: config/syslog-release-forwarding-rules.conf
  syslog-release-forwarding-setup.conf.erb: config/syslog-release-forwarding-setup.conf
  syslog-release-file-exclusion.conf.erb: config/syslog-release-file-exclusion.conf
  ca_cert.pem.erb: config/ca_cert.pem
  blackbox_ctl.erb: bin/blackbox_ctl
  blackbox_config.yml.erb: config/blackbox_config.yml
  drain.erb: bin/drain

packages:
  - blackbox

consumes:
  - name: syslog_storer
    type: syslog_storer
    optional: true

properties:
  syslog.director:
    description: "BOSH Director name"
    default: ""

  syslog.forward_files:
    description: If enabled, use BlackBox to forward logs.
    default: true
  syslog.respect_file_permissions:
    description: |
      If enabled, log files will be forwarded if and only if
      they satisfy any of the following:
      - world-readable
      - readable by the syslog user
      - readable by the vcap group
        (note: the vcap user is insufficient, it must be the group.)
    default: false
  syslog.use_tcp_for_file_forwarding_local_transport:
    description: >
      If enabled, Blackbox will use TCP rather than UDP
      when forwarding loglines from files
      to the local rsyslog.
      Does not affect forwarding to remote addresses.
      This prevents truncation of log lines over 1KB,
      but may have undesirable performance impact.
    default: false
  syslog.address:
    description: IP or DNS address of the syslog server.
    example: logs4.papertrail.com
  syslog.port:
    description: Port of the syslog server.
    default: 514
  syslog.transport:
    default: tcp
    description: One of `udp`, `tcp`, `relp`.
  syslog.fallback_servers:
    description: "List of fallback servers to be used if the primary syslog server is down. Only tcp or relp protocols are supported. Each list entry should consist of \"address\", \"transport\" and \"port\" keys."
    default: []
    example:
    - address: logs5.papertrail.com
      port: 44312
      transport: tcp

  syslog.custom_rule:
    description: |
      Custom rsyslog rule for event forwarder.
      This will be inserted before the forwarding rule.
      See further discussion and examples in
      example-custom-rules.md
      at the top level of the release repo.
    default: ""

  syslog.tls_enabled:
    description: Set this to true to enable TLS.
    default: false
  syslog.permitted_peer:
    description: >
      Accepted fingerprint (SHA1) or name of remote peer.
      Only used if TLS is enabled.
      If not specified, will use the configured forwarding address.
    example: "*.papertrail.com"
  syslog.ca_cert:
    description: |
      Trusted CAs. Necessary if TLS is enabled
      AND signing CA is not present in instance cert store.
      Overrides instance cert store if set.
    example: |
      -----BEGIN CERTIFICATE-----
      MIIClTCCAf4CCQDc6hJtvGB8RjANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMC...
      -----END CERTIFICATE-----
  syslog.queue_file_name:
    description: Spill to disk if queue is full.
    default: agg_backlog
  syslog.queue_max_disk_space:
    description: Max size for disk queue.
    default: 128m
  syslog.queue_size:
    description: Store no more than this number syslog messages in memory.
    default: 100000
  syslog.queue_discard_mark:
    description: After this number of messages are queued, purge messages whose severity is greater than or equal to DiscardSeverity.
    default: 97500
  syslog.queue_discard_severity:
    description: |
      This discards queued messages of this severity or higher when the `queue_discard_mark` is reached.
      Setting this to '0' will discard all queued messages when the `queue_discard_mark` is reached.
    default: 0
  syslog.queue_low_water_mark:
    description: Number of messages. Assuming avg size of 512B, this is 1MiB.
    default: 2000
  syslog.queue_high_water_mark:
    description: Num messages. Assuming avg size of 512B, this is 4MiB. (If this is reached, messages will spill to disk until the low watermark is reached).
    default: 80000
  syslog.queue_timeout_enqueue:
    description: Discard messages if the queue + disk is full
    default: 0
  syslog.queue_save_on_shutdown:
    description: Save in-memory data to disk if rsyslog shuts down. Must be "on" or "off"
    default: on
  syslog.resume_interval:
    description: When action is suspended (dest not connected), retry after this number of seconds
    default: 10
  syslog.queue_checkpoint_interval:
    description: write bookkeeping information on checkpoints (every n records)
    default: 100

  syslog.blackbox.source_dir:
    description: >
      directory with subdirectories containing log files.
      log lines will be tagged with subdirectory name.
    default: /var/vcap/sys/log

  syslog.blackbox.log_suffix:
    description: >
      log suffix with this ending.
      blackbox will search for files in the VCAP log directory. 
    default: log

  syslog.blackbox.limit_cpu:
    description: limit goprocess to a single cpu via gomaxprocs
    default: true

  syslog.migration.disabled:
    default: false
    description: |
      Deprecated.
      Allows systems that cannot modify their deployment toplogy
      to use this release.
      Do not use if you're not already relying on this capability.
      If true, does not forward syslogs,
      and does not require any other properties be provided.
      Overrides all other configuration.
